# coding=utf-8
from __future__ import unicode_literals
import scrapy
import pymongo
from doubanspider.items import BookinfoItem
from bs4 import BeautifulSoup
from scrapy.selector import Selector
import time

# 思路：200多个页面的url，从每个页面获取info简介，img图书，bookname书名，bookid每本书的id
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

class MyDoubanSpider(scrapy.Spider):
    name = 'bookinfo'

    def start_requests(self):
        all_books = ['https://book.douban.com/subject/1770782/','https://book.douban.com/subject/1084336/','https://book.douban.com/subject/1008145/','https://book.douban.com/subject/25862578','https://book.douban.com/subject/1082154/','https://book.douban.com/subject/3259440/','https://book.douban.com/subject/1046265/','https://book.douban.com/subject/3211779/','https://book.douban.com/subject/2567698/','https://book.douban.com/subject/1017143/','https://book.douban.com/subject/1007305/','https://book.douban.com/subject/1016300/','https://book.douban.com/subject/1040771/','https://book.douban.com/subject/20427187','https://book.douban.com/subject/6082808/','https://book.douban.com/subject/5275059/','https://book.douban.com/subject/1461903/','https://book.douban.com/subject/1200840/','https://book.douban.com/subject/1141406/','https://book.douban.com/subject/1041007/','https://book.douban.com/subject/10554308','https://book.douban.com/subject/3066477/','https://book.douban.com/subject/1068920/','https://book.douban.com/subject/4238362/','https://book.douban.com/subject/5363767/','https://book.douban.com/subject/4242172/','https://book.douban.com/subject/1083428/','https://book.douban.com/subject/1090043/','https://book.douban.com/subject/1026425/','https://book.douban.com/subject/2256039/','https://book.douban.com/subject/1873231/','https://book.douban.com/subject/1071241/','https://book.douban.com/subject/3995526/','https://book.douban.com/subject/1400705/','https://book.douban.com/subject/1039487/','https://book.douban.com/subject/1041482/','https://book.douban.com/subject/1023045/','https://book.douban.com/subject/1059406/','https://book.douban.com/subject/2209098/','https://book.douban.com/subject/1022060/','https://book.douban.com/subject/3879301/','https://book.douban.com/subject/4886245/','https://book.douban.com/subject/1529893/','https://book.douban.com/subject/1009257/','https://book.douban.com/subject/1057244/','https://book.douban.com/subject/1858513/','https://book.douban.com/subject/1066462/','https://book.douban.com/subject/4913064/','https://book.douban.com/subject/1082334/','https://book.douban.com/subject/25747921','https://book.douban.com/subject/2062200/','https://book.douban.com/subject/3646172/','https://book.douban.com/subject/1255625/','https://book.douban.com/subject/4074636/','https://book.douban.com/subject/1049219/','https://book.douban.com/subject/1432596/','https://book.douban.com/subject/2250587/','https://book.douban.com/subject/1045818/','https://book.douban.com/subject/1029791/','https://book.douban.com/subject/1049189/','https://book.douban.com/subject/1361264/','https://book.douban.com/subject/1948901/','https://book.douban.com/subject/10594787','https://book.douban.com/subject/1013129/','https://book.douban.com/subject/2022979/','https://book.douban.com/subject/26340138','https://book.douban.com/subject/3426869/','https://book.douban.com/subject/1059419/','https://book.douban.com/subject/1050339/','https://book.douban.com/subject/1085860/','https://book.douban.com/subject/1007914/','https://book.douban.com/subject/1019568/','https://book.douban.com/subject/1089243/','https://book.douban.com/subject/1003000/','https://book.douban.com/subject/1401425/','https://book.douban.com/subject/1119522/','https://book.douban.com/subject/1002299/','https://book.douban.com/subject/1775691/','https://book.douban.com/subject/3813669/','https://book.douban.com/subject/3369793/','https://book.douban.com/subject/2143732/','https://book.douban.com/subject/1064275/','https://book.douban.com/subject/2340100/','https://book.douban.com/subject/1082387/','https://book.douban.com/subject/3608208/','https://book.douban.com/subject/1040211/','https://book.douban.com/subject/3191328/','https://book.douban.com/subject/1465324/','https://book.douban.com/subject/1786670/','https://book.douban.com/subject/2256438/','https://book.douban.com/subject/1080370/','https://book.douban.com/subject/1024217/','https://book.douban.com/subject/1255624/','https://book.douban.com/subject/1453210/','https://book.douban.com/subject/1013380/','https://book.douban.com/subject/1082518/','https://book.douban.com/subject/3394338/','https://book.douban.com/subject/1065970/','https://book.douban.com/subject/3598313/','https://book.douban.com/subject/1827374/','https://book.douban.com/subject/2159042/','https://book.douban.com/subject/4714734/','https://book.douban.com/subject/6388661/','https://book.douban.com/subject/1029159/','https://book.douban.com/subject/3369600/','https://book.douban.com/subject/1949338/','https://book.douban.com/subject/1030052/','https://book.douban.com/subject/2154960/','https://book.douban.com/subject/5317075/','https://book.douban.com/subject/10763902','https://book.douban.com/subject/3014576/','https://book.douban.com/subject/1054685/','https://book.douban.com/subject/1085799/','https://book.douban.com/subject/1794620/','https://book.douban.com/subject/1205370/','https://book.douban.com/subject/1016003/','https://book.douban.com/subject/1221515/','https://book.douban.com/subject/1060068/','https://book.douban.com/subject/1024197/','https://book.douban.com/subject/1829226/','https://book.douban.com/subject/2053249/','https://book.douban.com/subject/26382433','https://book.douban.com/subject/4117922/','https://book.douban.com/subject/2243213/','https://book.douban.com/subject/5916880/','https://book.douban.com/subject/1056733/','https://book.douban.com/subject/1039752/','https://book.douban.com/subject/1013502/','https://book.douban.com/subject/1014278/','https://book.douban.com/subject/1856285/','https://book.douban.com/subject/4011670/','https://book.douban.com/subject/1882933/','https://book.douban.com/subject/1046209/','https://book.douban.com/subject/1449351/','https://book.douban.com/subject/3616310/','https://book.douban.com/subject/1596305/','https://book.douban.com/subject/1291760/','https://book.douban.com/subject/1227838/','https://book.douban.com/subject/4009552/','https://book.douban.com/subject/1917972/','https://book.douban.com/subject/1044547/','https://book.douban.com/subject/3674537/','https://book.douban.com/subject/1358873/','https://book.douban.com/subject/2052448/','https://book.douban.com/subject/1029111/','https://book.douban.com/subject/2331434/','https://book.douban.com/subject/1963684/','https://book.douban.com/subject/1020459/','https://book.douban.com/subject/2081876/','https://book.douban.com/subject/1962929/','https://book.douban.com/subject/25985021','https://book.douban.com/subject/3006581/','https://book.douban.com/subject/1346815/','https://book.douban.com/subject/1008988/','https://book.douban.com/subject/2056749/','https://book.douban.com/subject/1016523/','https://book.douban.com/subject/3344676/','https://book.douban.com/subject/3071717/','https://book.douban.com/subject/6710437/','https://book.douban.com/subject/1812439/','https://book.douban.com/subject/26278687','https://book.douban.com/subject/1058234/','https://book.douban.com/subject/1703544/','https://book.douban.com/subject/4124727/','https://book.douban.com/subject/1012611/','https://book.douban.com/subject/2057285/','https://book.douban.com/subject/2253642/','https://book.douban.com/subject/4238754/','https://book.douban.com/subject/2035179/','https://book.douban.com/subject/1469051/','https://book.douban.com/subject/1212893/','https://book.douban.com/subject/1086249/','https://book.douban.com/subject/1006881/','https://book.douban.com/subject/1034108/','https://book.douban.com/subject/1009160/','https://book.douban.com/subject/5414391/','https://book.douban.com/subject/2339950/','https://book.douban.com/subject/4113090/','https://book.douban.com/subject/1926700/','https://book.douban.com/subject/1204889/','https://book.douban.com/subject/1088065/','https://book.douban.com/subject/25984204','https://book.douban.com/subject/1963310/','https://book.douban.com/subject/26356948','https://book.douban.com/subject/1082406/','https://book.douban.com/subject/3009821/','https://book.douban.com/subject/1043815/','https://book.douban.com/subject/2298149/','https://book.douban.com/subject/1051193/','https://book.douban.com/subject/1043008/','https://book.douban.com/subject/1013208/','https://book.douban.com/subject/4010969/','https://book.douban.com/subject/1080309/','https://book.douban.com/subject/1018153/','https://book.douban.com/subject/1027191/','https://book.douban.com/subject/25924253','https://book.douban.com/subject/4038164/','https://book.douban.com/subject/3017857/','https://book.douban.com/subject/4166819/','https://book.douban.com/subject/4874131/','https://book.douban.com/subject/1474773/','https://book.douban.com/subject/4231381/','https://book.douban.com/subject/4207781/','https://book.douban.com/subject/5327697/','https://book.douban.com/subject/1205054/','https://book.douban.com/subject/3266344/','https://book.douban.com/subject/2139305/','https://book.douban.com/subject/1292416/','https://book.douban.com/subject/2070844/','https://book.douban.com/subject/1767945/','https://book.douban.com/subject/4908885/','https://book.douban.com/subject/24934182','https://book.douban.com/subject/6798611/','https://book.douban.com/subject/1863930/','https://book.douban.com/subject/1082349/','https://book.douban.com/subject/2567919/','https://book.douban.com/subject/1007334/','https://book.douban.com/subject/1059336/','https://book.douban.com/subject/1063190/','https://book.douban.com/subject/1431836/']
        # all_books = ['https://book.douban.com/subject/1084336/','https://book.douban.com/subject/1008145/','https://book.douban.com/subject/1770782/','https://book.douban.com/subject/1084336/']
        for everybook in all_books:
            url = everybook
            yield scrapy.Request(url=url, headers={'user-agent': 'Mozilla/5.0'}, meta={'bookurl': everybook})
            # time.sleep(0.05)

    def parse(self, response):
        item = BookinfoItem()
        selector = Selector(response)
        item['bookname'] = selector.xpath('//*[@id="wrapper"]/h1/span/text()').extract()[0].encode('utf8')
        # soup = BeautifulSoup(response.body, 'html.parser')
        # bookinfo = soup.find('div', {'class': 'intro'}).get_text()
        # xpath                                        用|表示或关系,就是正下方这个
        item['bookinfo'] = selector.xpath('//*[@id="link-report"]/div[1]/div | //*[@id="link-report"]/span[1]/div').extract()[0].encode('utf8')
        item['img'] = selector.xpath(' //*[@id="mainpic"]/a/img/@src').extract()[0]
        item['bookid'] = str(response.meta['bookurl'])
        print item['bookname'],   item['bookid'],    item['bookinfo'],  item['img'], '\n\n'


        yield item


